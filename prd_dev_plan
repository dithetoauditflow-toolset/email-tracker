# ðŸ“˜ Product Requirements Document (PRD) & Development Plan

## ðŸ§­ Project Overview

**Project Name:** Email Follow-Up Audit Tool
**Platform:** Streamlit (multi-user)
**Database:** SQLite (local file-based, fast I/O)
**Deployment:** Streamlit Cloud
**Primary Roles:**

* **Admin** â€“ Manages auditor accounts, internal domains, and follow-up settings.
* **Auditor** â€“ Uploads company lists, syncs emails, and tracks follow-up progress.

### ðŸŽ¯ Goal

To automate the tracking of auditor-client email communication, identifying clients who have **not replied within X working days** after the last auditor email.

---

## âš™ï¸ Core Functionalities

### ðŸ‘¤ 1. Authentication System

* Simple login with username/password stored securely in SQLite.
* Roles: Admin (1) and multiple Auditors.
* Admin can add/remove auditor accounts.

### âš¡ 2. Auditor Dashboard

* Upload company contact list (`UIF Ref`, `Trade Name`, `Email`, `Alt Email`).
* View current list in editable Streamlit table.
* Add/remove rows manually.
* Start email synchronization process.
* Display email counts, last sent/reply dates, and follow-up status.

### ðŸ’¬ 3. Email Synchronization Module

* Uses IMAP for incoming mail + SMTP for outgoing mail.
* Each auditor stores email credentials locally (encrypted).
* Pulls messages only from addresses in the uploaded list.
* Excludes internal domains (editable by Admin).
* Fetches and stores:

  * `Message ID`
  * `From`
  * `To`
  * `Subject`
  * `Date`
  * `Direction` (Incoming / Outgoing)
* Maintains **sync checkpoints** to only fetch new messages after the last sync.

### ðŸ“… 4. Follow-Up Logic

* Calculates true **working days** between `last sent` and `last reply`.
* Flags any contact exceeding the Admin-defined threshold (default: 3 days).
* Ignores weekends and public holidays (static JSON or config file).

### ðŸ“Š 5. Overdue Tab

* Displays contacts who havenâ€™t replied within X working days.
* Columns: `UIF Ref`, `Trade Name`, `Email`, `Last Sent`, `Last Reply`, `Days Since Last Reply`.
* Allows export to Excel.

### ðŸ§° 6. Admin Panel

* Manage auditor accounts (add/remove/reset password).
* Manage internal domains list (e.g., `@rbrgroup.co.za`).
* Set follow-up threshold (in working days).
* View overall summary per auditor.

---

## ðŸ§± System Architecture

```
streamlit_app/
â”‚
â”œâ”€â”€ main.py                  # Streamlit entrypoint, routing
â”œâ”€â”€ auth/                    # Authentication logic
â”‚   â”œâ”€â”€ login.py
â”‚   â”œâ”€â”€ register.py
â”‚   â”œâ”€â”€ session_manager.py
â”‚
â”œâ”€â”€ email_sync/              # Email fetching & storage
â”‚   â”œâ”€â”€ imap_handler.py
â”‚   â”œâ”€â”€ smtp_handler.py
â”‚   â”œâ”€â”€ email_parser.py
â”‚   â”œâ”€â”€ sync_manager.py
â”‚
â”œâ”€â”€ data/                    # Data models & persistence
â”‚   â”œâ”€â”€ db_manager.py        # SQLite connection manager
â”‚   â”œâ”€â”€ models.py            # Tables: users, emails, companies, settings
â”‚   â”œâ”€â”€ holidays.json        # Public holidays config
â”‚
â”œâ”€â”€ ui/                      # Streamlit pages
â”‚   â”œâ”€â”€ admin_page.py
â”‚   â”œâ”€â”€ auditor_dashboard.py
â”‚   â”œâ”€â”€ overdue_tab.py
â”‚
â”œâ”€â”€ utils/                   # Helper modules
â”‚   â”œâ”€â”€ date_utils.py        # Working day calculations
â”‚   â”œâ”€â”€ encryption.py        # Store email credentials securely
â”‚   â”œâ”€â”€ logger.py
â”‚
â””â”€â”€ tests/                   # Unit & integration tests
    â”œâ”€â”€ test_db.py
    â”œâ”€â”€ test_email_sync.py
    â”œâ”€â”€ test_followup_logic.py
```

---

## ðŸ§© Database Schema (SQLite)

### `users`

| Field         | Type    | Description                  |
| ------------- | ------- | ---------------------------- |
| id            | INTEGER | Primary key                  |
| username      | TEXT    | Unique                       |
| password_hash | TEXT    | Encrypted password           |
| role          | TEXT    | 'admin' or 'auditor'         |
| email_config  | JSON    | Encrypted IMAP/SMTP settings |

### `companies`

| Field      | Type    | Description          |
| ---------- | ------- | -------------------- |
| id         | INTEGER | Primary key          |
| auditor_id | INTEGER | FK to users          |
| uif_ref    | TEXT    | UIF reference number |
| trade_name | TEXT    | Company name         |
| email      | TEXT    | Main email address   |
| alt_email  | TEXT    | Alternative email    |

### `emails`

| Field      | Type     | Description              |
| ---------- | -------- | ------------------------ |
| id         | INTEGER  | Primary key              |
| auditor_id | INTEGER  | FK to users              |
| company_id | INTEGER  | FK to companies          |
| direction  | TEXT     | 'incoming' or 'outgoing' |
| from_addr  | TEXT     | Email sender             |
| to_addr    | TEXT     | Recipient                |
| subject    | TEXT     | Email subject            |
| date       | DATETIME | Email timestamp          |

### `settings`

| Field | Type | Description                               |
| ----- | ---- | ----------------------------------------- |
| key   | TEXT | e.g., 'internal_domains', 'followup_days' |
| value | TEXT | JSON or text value                        |

### `sync_log`

| Field      | Type     | Description          |
| ---------- | -------- | -------------------- |
| auditor_id | INTEGER  | FK to users          |
| last_sync  | DATETIME | Last sync checkpoint |

---

## ðŸ§  Core Logic & Rules

1. **Sync Filtering:**

   * Exclude internal domains in Admin settings.
   * Include only contacts from auditorâ€™s company list.

2. **Working Day Calculation:**

   * Use `date_utils.get_working_days(start, end)`.
   * Skip weekends and listed holidays.

3. **Follow-Up Identification:**

   * For each contact:

     * Find last outgoing email date.
     * Find latest incoming email after that.
     * If no reply and days > threshold â†’ mark as overdue.

4. **Incremental Sync:**

   * Save last sync date in `sync_log`.
   * On next sync, only pull emails newer than that date.

---

## ðŸ§ª Testing Strategy

* **Unit Tests** for all modules (`pytest`).
* **Integration Tests** for email sync using mock IMAP/SMTP servers.
* **UI Tests** with Streamlit test client.
* **Data Validation Tests** (ensure no duplicates, correct timestamps).

**Target Coverage:** â‰¥ 80%

---

## ðŸš€ Development Phases

| Phase | Duration | Module           | Description                         |
| ----- | -------- | ---------------- | ----------------------------------- |
| 1     | 1â€“2h     | Auth             | Admin + Auditor login, SQLite setup |
| 2     | 1â€“2h     | Company List     | Upload + edit company contacts      |
| 3     | 2h       | Email Sync       | IMAP/SMTP fetch + checkpoint logic  |
| 4     | 1h       | Working Day Calc | Utility for follow-up days          |
| 5     | 2h       | Dashboard        | Email counts + overdue detection    |
| 6     | 1h       | Admin Panel      | Manage auditors, settings, domains  |
| 7     | 1h       | Export + Testing | Excel export + full test run        |

---

## ðŸ§­ Development Principles

* **â‰¤200 LOC per file** (readable AI-cooperative modules)
* **Rapid Lean Loops** â†’ Plan â†’ Code â†’ Test â†’ Refactor â†’ Ship (â‰¤2h each)
* **Conventional Commits:**

  * `feat: add email sync checkpoint logic`
  * `fix: correct working day count on weekends`
* **CI/CD:** GitHub Actions â†’ Streamlit Cloud Deploy

---

## ðŸ“ˆ Impact Metrics

| Metric                          | Target  |
| ------------------------------- | ------- |
| Email sync accuracy             | â‰¥ 95%   |
| App load time                   | < 3s    |
| Follow-up detection correctness | â‰¥ 98%   |
| Test coverage                   | â‰¥ 80%   |
| Auditor onboarding time         | < 5 min |

---

## ðŸ”’ Security Considerations

* Passwords hashed (bcrypt).
* Email credentials AES-encrypted before storing.
* No plain-text credentials in memory longer than necessary.
* Secure Streamlit secrets management for encryption key.

---

## âœ… Next Steps

1. Initialize repo with modular folder structure.
2. Build `db_manager.py` and seed admin credentials.
3. Implement `auth/login.py` and `register.py`.
4. Connect dashboard with SQLite.
5. Test email sync using test IMAP account.

---

**Author:** Sir Banya
**Prepared for:** Baba Riri
**Version:** v1.0 â€“ MVP PRD + Dev Plan
